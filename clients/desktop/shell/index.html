<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chatalot</title>
<style>
	* { margin: 0; padding: 0; box-sizing: border-box; }
	html, body { width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #e0e0e0; }
	#connect-form { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 16px; padding: 24px; }
	#connect-form h1 { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
	#connect-form p { font-size: 14px; color: #a0a0b0; max-width: 360px; text-align: center; }
	#connect-form input { width: 100%; max-width: 360px; padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #e0e0e0; font-size: 14px; outline: none; }
	#connect-form input:focus { border-color: #6c5ce7; }
	#connect-form button { width: 100%; max-width: 360px; padding: 10px 14px; border-radius: 8px; border: none; background: #6c5ce7; color: white; font-size: 14px; font-weight: 500; cursor: pointer; }
	#connect-form button:hover { background: #5b4bd5; }
	#connect-form button:disabled { opacity: 0.5; cursor: not-allowed; }
	#connect-error { color: #ff6b6b; font-size: 13px; max-width: 360px; text-align: center; min-height: 20px; }
	#app-frame { display: none; width: 100%; height: 100%; border: none; }
	#loading { display: none; position: fixed; inset: 0; background: #1a1a2e; align-items: center; justify-content: center; flex-direction: column; gap: 12px; }
	.spinner { width: 32px; height: 32px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #6c5ce7; border-radius: 50%; animation: spin 0.8s linear infinite; }
	@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div id="connect-form">
	<h1>Chatalot</h1>
	<p>Enter the URL of your Chatalot server to connect.</p>
	<input id="server-input" type="url" placeholder="https://chat.example.com" autocomplete="url" />
	<div id="connect-error"></div>
	<button id="connect-btn" type="button">Connect</button>
</div>
<div id="loading">
	<div class="spinner"></div>
	<span style="font-size:14px;color:#a0a0b0">Connecting...</span>
</div>
<iframe id="app-frame"
	sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"
	allow="microphone; camera; notifications; clipboard-write"
></iframe>

<script>
(function() {
	const STORAGE_KEY = 'chatalot_server_url';
	const ALLOWED_ACTIONS = new Set([
		'store_key', 'get_key', 'delete_key',
		'check-update', 'set-server-url', 'clear-server-url',
		'reload-app'
	]);

	const form = document.getElementById('connect-form');
	const input = document.getElementById('server-input');
	const btn = document.getElementById('connect-btn');
	const errorEl = document.getElementById('connect-error');
	const loading = document.getElementById('loading');
	const iframe = document.getElementById('app-frame');

	let serverUrl = localStorage.getItem(STORAGE_KEY);

	// If we have a saved URL, go straight to loading
	if (serverUrl) {
		loadApp(serverUrl);
	}

	btn.addEventListener('click', handleConnect);
	input.addEventListener('keydown', function(e) {
		if (e.key === 'Enter') handleConnect();
	});

	async function handleConnect() {
		errorEl.textContent = '';
		let url = input.value.trim().replace(/\/+$/, '');
		if (!url) { errorEl.textContent = 'Please enter a server URL.'; return; }
		if (!/^https?:\/\//i.test(url)) url = 'https://' + url;

		btn.disabled = true;
		btn.textContent = 'Connecting...';

		try {
			const resp = await fetch(url + '/api/auth/config', { mode: 'cors', signal: AbortSignal.timeout(10000) });
			if (!resp.ok) throw new Error('Server returned ' + resp.status);
			const data = await resp.json();
			if (!data.registration_mode) throw new Error('Not a Chatalot server');
		} catch (err) {
			errorEl.textContent = 'Could not reach server: ' + (err.message || err);
			btn.disabled = false;
			btn.textContent = 'Connect';
			return;
		}

		localStorage.setItem(STORAGE_KEY, url);
		serverUrl = url;
		loadApp(url);
	}

	function loadApp(url) {
		form.style.display = 'none';
		loading.style.display = 'flex';

		iframe.src = url;
		iframe.onload = function() {
			loading.style.display = 'none';
			iframe.style.display = 'block';
		};
	}

	// ── postMessage bridge ──
	window.addEventListener('message', async function(event) {
		// Validate origin matches saved server URL
		if (!serverUrl) return;
		try {
			const expected = new URL(serverUrl).origin;
			if (event.origin !== expected) return;
		} catch { return; }

		const msg = event.data;
		if (!msg || typeof msg !== 'object' || msg.source !== 'chatalot-bridge') return;
		if (!ALLOWED_ACTIONS.has(msg.action)) {
			sendResponse(msg.id, null, 'Action not allowed: ' + msg.action);
			return;
		}

		try {
			var invoke = window.__TAURI_INTERNALS__?.invoke;
			let result = null;

			switch (msg.action) {
				case 'store_key': {
					if (!invoke) throw new Error('Tauri IPC not available');
					await invoke('store_key', { keyName: msg.payload.keyName, value: msg.payload.value });
					result = true;
					break;
				}
				case 'get_key': {
					if (!invoke) throw new Error('Tauri IPC not available');
					result = await invoke('get_key', { keyName: msg.payload.keyName });
					break;
				}
				case 'delete_key': {
					if (!invoke) throw new Error('Tauri IPC not available');
					await invoke('delete_key', { keyName: msg.payload.keyName });
					result = true;
					break;
				}
				case 'check-update': {
					// Shell handles binary updates — iframe just asks
					result = { available: false };
					break;
				}
				case 'set-server-url': {
					if (msg.payload?.url) {
						localStorage.setItem(STORAGE_KEY, msg.payload.url);
						serverUrl = msg.payload.url;
					}
					result = true;
					break;
				}
				case 'clear-server-url': {
					localStorage.removeItem(STORAGE_KEY);
					serverUrl = null;
					iframe.style.display = 'none';
					form.style.display = 'flex';
					result = true;
					break;
				}
				case 'reload-app': {
					// Force-reload the iframe with a cache-busting URL
					iframe.src = serverUrl + '?_v=' + Date.now();
					result = true;
					break;
				}
			}

			sendResponse(msg.id, result, null);
		} catch (err) {
			sendResponse(msg.id, null, err.message || String(err));
		}
	});

	function sendResponse(id, result, error) {
		if (!iframe.contentWindow) return;
		iframe.contentWindow.postMessage({
			source: 'chatalot-shell',
			id: id,
			result: result,
			error: error
		}, '*');
	}

	// ── Tauri binary update check on startup ──
	(async function checkBinaryUpdate() {
		if (!window.__TAURI_INTERNALS__) return;
		try {
			const { invoke } = window.__TAURI_INTERNALS__;
			// Use Tauri's built-in updater if available
		} catch {}
	})();
})();
</script>
</body>
</html>
