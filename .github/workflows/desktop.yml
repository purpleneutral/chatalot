name: Build Desktop App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # ── Windows: use tauri-action (straightforward) ──────────────
  build-windows:
    permissions:
      contents: write
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: clients/web/package-lock.json

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: |
            clients/desktop/src-tauri -> target
            . -> target

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0

      - name: Build WASM crypto module
        run: wasm-pack build crates/chatalot-crypto-wasm --target web --out-dir ../../clients/web/src/lib/crypto/wasm --out-name chatalot_crypto_wasm

      - name: Install web dependencies
        working-directory: clients/web
        run: npm ci

      - name: Build & release desktop app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: clients/desktop
          tagName: v__VERSION__
          releaseName: Chatalot v__VERSION__
          releaseBody: |
            Desktop app release. Download the appropriate installer for your platform:
            - **Linux**: AppImage (portable) or .deb (Debian/Ubuntu)
            - **Windows**: NSIS installer (.exe)
          releaseDraft: true
          prerelease: false
          includeUpdaterJson: true

  # ── Linux: manual build + strip bundled GTK from AppImage ────
  build-linux:
    permissions:
      contents: write
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libsecret-1-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: clients/web/package-lock.json

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: |
            clients/desktop/src-tauri -> target
            . -> target

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0

      - name: Build WASM crypto module
        run: wasm-pack build crates/chatalot-crypto-wasm --target web --out-dir ../../clients/web/src/lib/crypto/wasm --out-name chatalot_crypto_wasm

      - name: Install web dependencies
        working-directory: clients/web
        run: npm ci

      - name: Build Tauri app
        working-directory: clients/desktop
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npx --yes @tauri-apps/cli build

      - name: Strip bundled GTK/GLib from AppImage
        run: |
          APPIMAGE=$(find clients/desktop/src-tauri/target/release/bundle/appimage -name '*.AppImage' | head -1)
          echo "Found AppImage: $APPIMAGE"

          # Extract
          chmod +x "$APPIMAGE"
          "$APPIMAGE" --appimage-extract

          # Remove ALL bundled libs and GTK modules that conflict with newer distros.
          # On modern distros (Arch, Fedora 40+, Ubuntu 24.04+), system libs are
          # newer than the Ubuntu 22.04 ones bundled here. Mixing versions causes
          # GTK init failures. WebKitGTK is a runtime dep anyway.
          rm -rf squashfs-root/usr/lib/x86_64-linux-gnu
          rm -f squashfs-root/usr/lib/*.so*

          # Replace AppRun entirely — the linuxdeploy-generated AppRun.wrapped
          # binary hardcodes LD_LIBRARY_PATH to the (now empty) bundled lib dirs,
          # which shadows system libs and causes GTK init failures.
          # We exec the binary directly, only setting GDK_BACKEND=x11
          # (Wayland backend crashes in AppImage context).
          printf '#!/usr/bin/env bash\nexport GDK_BACKEND=x11\nexec "$(dirname "$(readlink -f "$0")")"/usr/bin/chatalot-desktop "$@"\n' > squashfs-root/AppRun
          chmod +x squashfs-root/AppRun

          # Repackage using appimagetool
          wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
          ARCH=x86_64 ./appimagetool --appimage-extract-and-run squashfs-root "$APPIMAGE"
          rm -rf squashfs-root appimagetool

      - name: Sign AppImage for updater
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          APPIMAGE=$(find clients/desktop/src-tauri/target/release/bundle/appimage -name '*.AppImage' | head -1)
          npx --yes @tauri-apps/cli signer sign "$APPIMAGE"

      - name: Get version from tauri.conf.json
        id: version
        run: echo "version=$(jq -r .version clients/desktop/src-tauri/tauri.conf.json)" >> "$GITHUB_OUTPUT"

      - name: Upload to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v${VERSION}"

          # Create release if it doesn't exist (Windows job may have created it)
          gh release view "$TAG" > /dev/null 2>&1 || \
            gh release create "$TAG" --draft --title "Chatalot v${VERSION}" --notes "Desktop app release."

          # Upload AppImage, deb, rpm + signatures
          for f in clients/desktop/src-tauri/target/release/bundle/appimage/*.AppImage \
                   clients/desktop/src-tauri/target/release/bundle/appimage/*.AppImage.sig \
                   clients/desktop/src-tauri/target/release/bundle/deb/*.deb \
                   clients/desktop/src-tauri/target/release/bundle/deb/*.deb.sig \
                   clients/desktop/src-tauri/target/release/bundle/rpm/*.rpm \
                   clients/desktop/src-tauri/target/release/bundle/rpm/*.rpm.sig; do
            [ -f "$f" ] && gh release upload "$TAG" "$f" --clobber
          done
